# 优化之路

## 1.首屏关键资源，减少关键资源数
1. css放在header，使用媒体查询加载css media="print"
>浏览器会在加载完DOM和CSSOM后开始渲染页面, 内联和link方式均会阻塞初次渲染
>浏览器会在下载完成全部CSS之后才对整个页面进行渲染, 因此最好的做法是将CSS放在页面最上面，让浏览器尽快下载CSS。如果将 CSS放在其他地方比如 BODY中，则浏览器有可能还未下载和解析到 CSS就已经开始渲染页面了，这就导致页面由无 CSS状态跳转到 CSS状态，用户体验比较糟糕，所以可以考虑将CSS放在HEAD中。

### css阻塞初次渲染
```html
<link> 会
<media = "print"> 不会
<script>document.write 会
<script>document.creatElement("link") 不会
preload <link rel="preload" href="" onload="this.rel = 'stylesheet'"> 不会
```
2. js放在body底部, defer,async加载, 按需加载
>浏览器执行js时，会暂停解析DOM工作
>CSS会阻塞js，因为js可能会读取或修改css，因为必须等待CSSOM构造完
浏览器在加载javascript后立即执行，有可能会阻塞整个页面，造成页面显示缓慢，因此javascript最好放在页面最下面
只有在需要加载的时候加载，在一般情况下并不加载信息内容

### js阻塞
文档底部，延迟js执行
defer延迟脚本执行，js将在HTML解析完后**顺序**执行，这样也可以提前让浏览器加载文件
async异步加载脚本，不会阻塞html解析，而且不会被css阻塞， 加载完便可执行，适用于无依赖的独立资源

3. 异步加载字体，字体会阻塞显示（空白屏）

4. 加载首屏图片
页面刚加载的时候可以只加载第一屏，当用户继续往后滚屏的时候才加载后续的图片

5. 合理应用内联，减少关键资源网络来回

## 2. 网络请求数量
1. 减少http请求，合理设置http缓存
cache-control, expires, Etag, last-modify

2. 浏览器缓存
 对一个网站而言，CSS、javascript、logo、图标这些静态资源文件更新的频率都比较低，缓存在浏览器中
 通过改变文件名实现，更新javascript文件

3. 合并+内联： webpack
合并CSS、合并javascript、合并图片（css sprite）
图片、音频内联（Data URI）；

## 3. 内容传输大小
1. 压缩
在服务器端对文件进行压缩，在浏览器端对文件解压缩：HTML、CSS、javascript文件启用GZip压缩
图片压缩，矢量图， 图片使用.webp格式
矢量图标（CSS 3 / Web Font / SVG）；
使用 Video 替换 Gif；
2. 缓存

## 4. 网络层面
1. cnd加速
将数据缓存在离用户最近的地方，使用户以最快速度获取数据，减少数据中心负载压力
>CDN缓存的一般是静态资源，如图片、文件、CSS、script脚本、静态网页等，但是这些文件访问频度很高，将其缓存在CDN可极大改善网页的打开速度。

2. 反向代理
反向代理也可以实现负载均衡的功能，而通过负载均衡构建的应用集群可以提高系统总体处理能力，进而改善网站高并发情况下的性能。
>传统代理服务器位于浏览器一侧，代理浏览器将http请求发送到互联网上，而反向代理服务器位于网站机房一侧，代理网站web服务器接收http请求.
>论坛网站，把热门词条、帖子、博客缓存在反向代理服务器上加速用户访问速度，当这些动态内容有变化时，通过内部通知机制通知反向代理缓存失效，反向代理会重新加载最新的动态内容再次缓存起来。

3. 减少cookie传输,cookie的大小
一方面，cookie包含在每次请求和响应中，太大的cookie会严重影响数据传输，因此哪些数据需要写入cookie需要慎重考虑，尽量减少cookie中传输的数据量。
另一方面，对于某些静态资源的访问，如CSS、script等，发送cookie没有意义，可以考虑静态资源使用独立域名访问，避免请求静态资源时发送cookie，减少cookie传输次数。

4. connection:Keep-Alive 
由于 TCP 的三次握手及慢启动，建立新连接成本很高

5. 启用http2： 多路技术，头压缩
HTTP/1.1 中，一个 TCP 连接上只能有一个请求 / 响应（TCP 并发连接）
使用多路技术，允许多个消息在一个连接上同时交差。
头压缩（header compression），因此即使非常小的请求，其请求和响应的header都只会占用很小比例的带宽

6. 域名分割，分散到不同的域
为了公平原则，浏览器针对同域名有并发连接数限制（通常为 6个 / 域名）；


## 5. 代码层面
1. CSS选择符优化
在大多数人的观念中，都觉得浏览器对 CSS选择符的解析式从左往右进行的，例如 
.toc A { color: #444; }这样一个选择符，如果是从右往左解析则效率会很高，因为第一个 ID选择基本上就把查找的范围限定了，但实际上浏览器对选择符的解析是从右往左进行的。如上面的选择符，浏览器必须遍历查找每一个 A标签的祖先节点，效率并不像之前想象的那样高。根据浏览器的这一行为特点，在写选择符的时候需要注意很多事项，有兴趣的童鞋可以去了解一下。
2. 少用全局变量
3. 用innerHTML代替DOM操作，减少DOM操作次数，优化javascript性能
>document.write()方法可以用在两个方面：页面载入过程中用实时脚本创建页面内容，以及用延时脚本创建本窗口或新窗口的内容。
document.write只能重绘整个页面。innerHTML可以重绘页面的一部分

4. 用setTimeout来避免页面失去响应
5. 缓存DOM节点查找的结果
6. 避免使用CSS Expression
7. 多个变量声明合并
8. 尽量避免写在HTML标签中写Style属性
9. 避免图片和iFrame等的空Src。空Src会重新加载当前页面，影响速度和效率
10. 避免全局查询
11. 尽量避免重排

## 6.移动端性能优化
1. 尽量使用css3动画，开启**硬件加速**。
2. 适当使用touch事件代替click事件。
3. 避免使用css3渐变阴影效果。
4. 可以用transform: translateZ(0)来开启硬件加速。
5. 不滥用Float。Float在渲染时计算量比较大，尽量减少使用
6. 不滥用Web字体。Web字体需要下载，解析，重绘当前页面，尽量减少使用。
7. 合理使用requestAnimationFrame动画代替setTimeout
8. CSS中的属性（CSS3 transitions、CSS3 3D transforms、Opacity、Canvas、WebGL、Video）会触发GPU渲染，请合理使用。过渡使用会引发手机过耗电增加
9. 组件大小<25KB
